<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* Estilos generales y tema oscuro */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .nav-tabs .nav-link {
            color: var(--bs-secondary-color);
        }
        .nav-tabs .nav-link.active {
            color: var(--bs-emphasis-color);
            background-color: var(--bs-tertiary-bg);
            border-color: var(--bs-border-color) var(--bs-border-color) var(--bs-tertiary-bg);
        }
        .table-hover tbody tr:hover {
            background-color: var(--bs-tertiary-bg);
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: var(--bs-secondary-bg);
        }
        #suggestions {
            border: 1px solid var(--bs-border-color);
            border-radius: var(--bs-border-radius);
            position: absolute;
            background-color: var(--bs-body-bg);
            width: 100%;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Mi PDV</a>
        </div>
    </nav>

    <div class="container mt-4">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales-tab-pane" type="button" role="tab">Ventas</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="returns-tab" data-bs-toggle="tab" data-bs-target="#returns-tab-pane" type="button" role="tab">Devoluciones</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="apartados-tab" data-bs-toggle="tab" data-bs-target="#apartados-tab-pane" type="button" role="tab">Apartados</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cuentas-tab" data-bs-toggle="tab" data-bs-target="#cuentas-tab-pane" type="button" role="tab">Cuentas por Pagar</button>
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" id="new-sale-tab" data-bs-toggle="tab" data-bs-target="#new-sale-tab-pane" type="button" role="tab"><strong>+ Nueva Venta</strong></button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="sales-tab-pane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <h3>Ventas Realizadas</h3>
                </div>
                <div class="table-responsive mt-3">
                    <table class="table table-hover" id="salesTable">
                        <thead>
                            <tr>
                                <th>Folio</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="returns-tab-pane" role="tabpanel">
                 <h3 class="mt-3">Devoluciones Realizadas</h3>
                 <div class="table-responsive mt-3">
                    <table class="table table-hover" id="returnsTable">
                        <thead>
                            <tr>
                                <th>Folio Dev.</th>
                                <th>Folio Venta Original</th>
                                <th>Fecha</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="apartados-tab-pane" role="tabpanel">
                <h3 class="mt-3">Sistema de Apartados</h3>
                <div class="table-responsive mt-3">
                    <table class="table table-hover" id="apartadosTable">
                        <thead>
                            <tr>
                                <th>Folio</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Saldo Pendiente</th>
                                <th>Estado</th>
                                <th>Vencimiento</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="cuentas-tab-pane" role="tabpanel">
                <h3 class="mt-3">Cuentas por Pagar</h3>
                 <div class="table-responsive mt-3">
                    <table class="table table-hover" id="cuentasPorPagarTable">
                        <thead>
                            <tr>
                                <th>Folio</th>
                                <th>Proveedor</th>
                                <th>Concepto</th>
                                <th>Monto Inicial</th>
                                <th>Saldo</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="new-sale-tab-pane" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-8">
                        <h3>Nueva Venta</h3>
                         <div class="mb-3 position-relative">
                            <label for="productSearch" class="form-label">Buscar producto por clave o concepto</label>
                            <input type="text" class="form-control" id="productSearch" autocomplete="off">
                            <div id="suggestions" class="list-group position-absolute w-100" style="display: none;"></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="cartTable">
                                <thead>
                                    <tr>
                                        <th>Clave</th>
                                        <th>Concepto</th>
                                        <th>Precio</th>
                                        <th>Cantidad</th>
                                        <th>Desc.</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Resumen de la Venta</h5>
                                <div class="mb-3">
                                    <label for="clienteInput" class="form-label">Cliente</label>
                                    <input type="text" id="clienteInput" class="form-control" value="Cliente General">
                                </div>
                                <div class="mb-3">
                                    <label for="generalDiscount" class="form-label">Descuento General (%)</label>
                                    <input type="number" id="generalDiscount" class="form-control" value="0" min="0" max="100">
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between fs-4">
                                    <strong>Total:</strong>
                                    <strong id="grandTotal">$0.00</strong>
                                </div>
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn btn-success btn-lg" id="finalizeSaleBtn">Finalizar Venta</button>
                                    <button class="btn btn-danger">Cancelar Venta</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="saleDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de la Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="saleDetailsModalBody">
                    </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="discountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Aplicar Descuento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="discountModalClave">
                    <div class="mb-3">
                        <label for="itemDiscountInput" class="form-label">Porcentaje de Descuento (%)</label>
                        <input type="number" class="form-control" id="itemDiscountInput" min="0" max="100" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="applyDiscountButton">Aplicar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Procesar Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h3 class="text-center mb-3">Total a Pagar: <span id="paymentModalTotal">$0.00</span></h3>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Efectivo $</span>
                        <input type="number" class="form-control" id="montoEfectivo">
                    </div>
                     <div class="input-group mb-3">
                        <span class="input-group-text">Tarjeta $</span>
                        <input type="number" class="form-control" id="montoTarjeta">
                    </div>
                     <div class="input-group">
                        <span class="input-group-text">Transfer. $</span>
                        <input type="number" class="form-control" id="montoTransferencia">
                    </div>
                </div>
                <div class="modal-footer">
                     <button type="button" class="btn btn-success" id="processPaymentBtn">Confirmar Pago</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        let ventasRealizadas = [];
        let devolucionesRealizadas = [];
        let apartados = [];
        let cuentasPorPagar = [];

        function loadInitialData() {
          fetch('pdv_data.json')
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
              }
              return response.json();
            })
            .then(data => {
              ventasRealizadas = data.ventasRealizadas || [];
              devolucionesRealizadas = data.devolucionesRealizadas || [];
              apartados = data.apartados || [];
              cuentasPorPagar = data.cuentasPorPagar || [];

              updateSalesTable();
              updateReturnsTable();
              updateApartadosTable();
              updateCuentasPorPagarTable();
            })
            .catch(error => {
              console.error('Error al cargar los datos iniciales:', error);
              alert('No se pudieron cargar los datos iniciales. Revisa la consola para más detalles.');
            });
        }

        function updateSalesTable() {
          const tbody = document.getElementById('salesTable').querySelector('tbody');
          tbody.innerHTML = '';
          ventasRealizadas.forEach(venta => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = venta.folio;
            row.insertCell(1).textContent = venta.client;
            row.insertCell(2).textContent = new Date(venta.date).toLocaleString();
            row.insertCell(3).textContent = `$${venta.total.toFixed(2)}`;
            const detailsCell = row.insertCell(4);
            const detailsButton = document.createElement('button');
            detailsButton.textContent = 'Ver Detalles';
            detailsButton.className = 'btn btn-info btn-sm';
            detailsButton.onclick = () => showSaleDetails(venta.folio);
            detailsCell.appendChild(detailsButton);
          });
        }

        function updateReturnsTable() {
          const tbody = document.getElementById('returnsTable').querySelector('tbody');
          tbody.innerHTML = '';
          devolucionesRealizadas.forEach(devolucion => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = devolucion.folio;
            row.insertCell(1).textContent = devolucion.originalSaleFolio;
            row.insertCell(2).textContent = new Date(devolucion.date).toLocaleString();
            row.insertCell(3).textContent = `$${devolucion.totalRefund.toFixed(2)}`;
          });
        }

        function updateApartadosTable() {
            const tbody = document.getElementById('apartadosTable').querySelector('tbody');
            tbody.innerHTML = '';
            apartados.forEach(apartado => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = apartado.folioApartado;
                row.insertCell(1).textContent = apartado.clienteNombre;
                row.insertCell(2).textContent = `$${apartado.total.toFixed(2)}`;
                row.insertCell(3).textContent = `$${apartado.saldoPendiente.toFixed(2)}`;
                row.insertCell(4).textContent = apartado.estado;
                row.insertCell(5).textContent = new Date(apartado.fechaVencimiento).toLocaleDateString();
            });
        }

        function updateCuentasPorPagarTable() {
            const tbody = document.getElementById('cuentasPorPagarTable').querySelector('tbody');
            tbody.innerHTML = '';
            cuentasPorPagar.forEach(cuenta => {
                const row = tbody.insertRow();
                let saldo = cuenta.montoInicial - (cuenta.historialAbonos || []).reduce((acc, abono) => acc + (abono.montoTotal || 0), 0);
                row.insertCell(0).textContent = cuenta.folio;
                row.insertCell(1).textContent = cuenta.proveedorNombre;
                row.insertCell(2).textContent = cuenta.concepto;
                row.insertCell(3).textContent = `$${cuenta.montoInicial.toFixed(2)}`;
                row.insertCell(4).textContent = `$${saldo.toFixed(2)}`;
            });
        }

        window.showSaleDetails = function(folio) {
          const venta = ventasRealizadas.find(v => v.folio === folio);
          if (!venta) return;

          const modalBody = document.getElementById('saleDetailsModalBody');
          modalBody.innerHTML = `
            <p><strong>Folio:</strong> ${venta.folio}</p>
            <p><strong>Cliente:</strong> ${venta.client}</p>
            <p><strong>Fecha:</strong> ${new Date(venta.date).toLocaleString()}</p>
            <h5>Artículos:</h5>
            <ul class="list-group">
              ${venta.items.map(item => `
                <li class="list-group-item">
                  ${item.cantidad} x ${item.concepto} (${item.clave}) - $${(item.precio * item.cantidad).toFixed(2)}
                </li>
              `).join('')}
            </ul>
            <hr>
            <p class="text-end"><strong>Total: $${venta.total.toFixed(2)}</strong></p>
          `;

          const saleDetailsModal = new bootstrap.Modal(document.getElementById('saleDetailsModal'));
          saleDetailsModal.show();
        }

        let carrito = [];

        document.getElementById('productSearch').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          if (searchTerm.length < 2) {
              document.getElementById('suggestions').style.display = 'none';
              return;
          };

          const mockProductos = [
              { clave: "FOS75L60200", concepto: "Collar Laminado", precio: 200 },
              { clave: "FPR75L40100", concepto: "Huggi Laminado", precio: 100 },
              { clave: "FOS75L60230", concepto: "Collar Laminado", precio: 230 },
          ];

          const results = mockProductos.filter(p => 
              p.clave.toLowerCase().includes(searchTerm) || 
              p.concepto.toLowerCase().includes(searchTerm)
          );

          const suggestions = document.getElementById('suggestions');
          suggestions.innerHTML = '';
          if(results.length > 0) {
              results.forEach(p => {
                  const div = document.createElement('div');
                  div.textContent = `${p.clave} - ${p.concepto} ($${p.precio})`;
                  div.className = 'suggestion-item';
                  div.onclick = () => addProductToCart(p);
                  suggestions.appendChild(div);
              });
              suggestions.style.display = 'block';
          } else {
              suggestions.style.display = 'none';
          }
        });

        document.addEventListener('click', function(e) {
            if (!document.getElementById('productSearch').contains(e.target)) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

        function addProductToCart(producto) {
            const existingItem = carrito.find(item => item.clave === producto.clave);
            if (existingItem) {
                existingItem.cantidad++;
            } else {
                carrito.push({ ...producto, cantidad: 1, discount: 0 });
            }
            document.getElementById('productSearch').value = '';
            document.getElementById('suggestions').style.display = 'none';
            updateCartTable();
        }

        function updateCartTable() {
            const tbody = document.getElementById('cartTable').querySelector('tbody');
            tbody.innerHTML = '';
            carrito.forEach((item, index) => {
                const row = tbody.insertRow();
                row.dataset.clave = item.clave;
                row.insertCell(0).textContent = item.clave;
                row.insertCell(1).textContent = item.concepto;
                row.insertCell(2).textContent = `$${item.precio.toFixed(2)}`;

                const quantityCell = row.insertCell(3);
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.className = 'form-control form-control-sm quantity-input';
                quantityInput.value = item.cantidad;
                quantityInput.min = 1;
                quantityInput.onchange = () => updateQuantity(item.clave, quantityInput.value);
                quantityCell.appendChild(quantityInput);

                const discountCell = row.insertCell(4);
                discountCell.textContent = `${item.discount}%`;

                const totalCell = row.insertCell(5);
                const subtotal = item.precio * item.cantidad;
                const totalConDescuento = subtotal - (subtotal * (item.discount / 100));
                totalCell.textContent = `$${totalConDescuento.toFixed(2)}`;

                const actionsCell = row.insertCell(6);
                const discountButton = document.createElement('button');
                discountButton.innerHTML = '<i class="bi bi-tag-fill"></i>';
                discountButton.className = 'btn btn-warning btn-sm me-1';
                discountButton.title = 'Aplicar descuento';
                discountButton.onclick = () => openDiscountModal(discountButton);

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '<i class="bi bi-trash-fill"></i>';
                removeButton.className = 'btn btn-danger btn-sm';
                removeButton.title = 'Eliminar';
                removeButton.onclick = () => removeFromCart(item.clave);

                actionsCell.appendChild(discountButton);
                actionsCell.appendChild(removeButton);
            });
            updateGrandTotal();
        }

        function updateQuantity(clave, nuevaCantidad) {
            const item = carrito.find(i => i.clave === clave);
            if(item) {
                item.cantidad = parseInt(nuevaCantidad, 10);
                if (item.cantidad < 1) item.cantidad = 1;
                updateCartTable();
            }
        }

        function removeFromCart(clave) {
            carrito = carrito.filter(item => item.clave !== clave);
            updateCartTable();
        }

        window.openDiscountModal = function(button) {
            const row = button.closest('tr');
            const clave = row.dataset.clave;
            document.getElementById('discountModalClave').value = clave;
            const modal = new bootstrap.Modal(document.getElementById('discountModal'));
            modal.show();
        }

        document.getElementById('applyDiscountButton').addEventListener('click', function() {
            const clave = document.getElementById('discountModalClave').value;
            const discount = parseFloat(document.getElementById('itemDiscountInput').value);
            const item = carrito.find(i => i.clave === clave);
            if (item && !isNaN(discount) && discount >= 0 && discount <= 100) {
                item.discount = discount;
                updateCartTable();
            }
            const modal = bootstrap.Modal.getInstance(document.getElementById('discountModal'));
            modal.hide();
        });

        function updateGrandTotal() {
            let total = 0;
            carrito.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal - (subtotal * (item.discount / 100));
            });

            const generalDiscount = parseFloat(document.getElementById('generalDiscount').value) || 0;
            const finalTotal = total - (total * (generalDiscount / 100));

            document.getElementById('grandTotal').textContent = `$${finalTotal.toFixed(2)}`;
        }

        document.getElementById('generalDiscount').addEventListener('input', updateGrandTotal);

        document.getElementById('finalizeSaleBtn').addEventListener('click', function() {
            if (carrito.length === 0) {
                alert('El carrito está vacío.');
                return;
            }

            const totalText = document.getElementById('grandTotal').textContent;

            document.getElementById('paymentModalTotal').textContent = totalText;
            document.getElementById('montoEfectivo').value = '';
            document.getElementById('montoTarjeta').value = '';
            document.getElementById('montoTransferencia').value = '';

            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();
        });

        document.getElementById('processPaymentBtn').addEventListener('click', function() {
            alert('Venta finalizada (simulación). Los datos se actualizarían en un backend real.');

            carrito = [];
            updateCartTable();
            document.getElementById('clienteInput').value = 'Cliente General';
            document.getElementById('generalDiscount').value = 0;
            updateGrandTotal();

            const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            paymentModal.hide();
        });

        loadInitialData();
      });
    </script>
</body>
</html>
